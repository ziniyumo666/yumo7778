<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>輪椅傾倒辨識與影像系統</title>
  <script type="module">
    import {
      HandLandmarker,
      FilesetResolver,
      DrawingUtils
    } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

    let handLandmarker;

    async function setupHandModel() {
      const filesetResolver = await FilesetResolver.forVisionTasks();
      handLandmarker = await HandLandmarker.createFromOptions(filesetResolver, {
        baseOptions: {
          modelAssetPath: `https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm/hand_landmarker.task`
        },
        runningMode: 'IMAGE',
        numHands: 1
      });
    }

    async function detectGesture() {
      const image = new Image();
      image.crossOrigin = "anonymous";
      image.src = "/latest.jpg?t=" + Date.now();

      image.onload = async () => {
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = image.width;
        canvas.height = image.height;
        ctx.drawImage(image, 0, 0);

        const result = await handLandmarker.detect(image);
        const statusBox = document.getElementById("status");

        if (result.landmarks.length > 0) {
          const drawingUtils = new DrawingUtils(ctx);
          drawingUtils.drawConnectors(result.landmarks[0], HandLandmarker.HAND_CONNECTIONS);
          drawingUtils.drawLandmarks(result.landmarks[0]);

          const hand = result.landmarks[0];
          const fingers = [
            [4, 3], [8, 6], [12, 10], [16, 14], [20, 18]
          ];
          let count = 0;
          for (let [tip, joint] of fingers) {
            if (hand[tip].y < hand[joint].y) count++;
          }

          statusBox.innerText = `🖐️ 偵測到手勢：${count}`;
        } else {
          statusBox.innerText = "🛑 未偵測到手部";
        }

        document.getElementById("camera").src = image.src;
        document.getElementById("imageTime").innerText = '圖片更新時間：' + new Date().toLocaleTimeString();
      };

      image.onerror = () => {
        document.getElementById("status").innerText = "❌ 圖片載入失敗 /latest.jpg 不存在";
      };
    }

    async function loadLogs() {
      try {
        const res = await fetch('/logs');
        const logs = await res.json();
        const table = document.getElementById("logTable");
        table.innerHTML = '<tr><th>事件</th><th>時間</th></tr>';
        logs.reverse().forEach(log => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${log.event}</td><td>${log.time}</td>`;
          table.appendChild(row);
        });
      } catch (e) {
        console.warn("❌ 無法載入 log 資料");
      }
    }

    async function loadLogTimestamp() {
      try {
        const res = await fetch('/log.txt');
        const text = await res.text();
        const lines = text.trim().split('\n');
        const latest = lines[lines.length - 1];
        document.getElementById("logContent").textContent = latest;
      } catch (e) {
        document.getElementById("logContent").textContent = '⚠️ 無法載入上傳時間';
      }
    }

    async function main() {
      await setupHandModel();
      detectGesture();
      loadLogs();
      loadLogTimestamp();
      setInterval(() => {
        detectGesture();
        loadLogs();
        loadLogTimestamp();
      }, 5000);
    }

    main();
  </script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      background-color: #f4f6f8;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #3f51b5;
      color: white;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    main {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    canvas, img {
      margin-top: 20px;
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    table {
      width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background-color: #3f51b5;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    #logContent, #imageTime, #status {
      margin-top: 20px;
      font-size: 16px;
      background: #eef1f5;
      padding: 10px;
      border-radius: 6px;
      display: inline-block;
      color: #333;
    }
    footer {
      margin-top: 30px;
      padding: 10px;
      font-size: 12px;
      color: #888;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <h1>輪椅傾倒辨識與手勢分析</h1>
  </header>
  <main>
    <h2>傾倒事件紀錄</h2>
    <table id="logTable">
      <tr><th>事件</th><th>時間</th></tr>
    </table>

    <h2>即時影像</h2>
    <img id="camera" src="/latest.jpg" alt="Loading image...">
    <canvas id="canvas"></canvas>
    <div id="imageTime">圖片更新時間：-</div>

    <h2>最後上傳時間</h2>
    <pre id="logContent">載入中...</pre>

    <h2>模型辨識結果</h2>
    <div id="status">🔄 載入中...</div>
  </main>
  <footer>
    Powered by MediaPipe ｜ Sausagee Party Server
  </footer>
</body>
</html>

main();
</script>
</body>
</html>
